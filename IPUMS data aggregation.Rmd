---
title: "IPUMS Data aggregation"
author: "David Gill and Matheus De Nardo"
date: "September 11, 2017"
output: html_document
---

## IPUMS data
This code is used to aggregate social and economic variables from IPUMS at the Geolevel 1 and 2 scale. These data will be used to assess social and economic differences in MPA vs non-MPA communities, both in terms of placement and changes over time. Here data are derived from the IPUMS website on educational attainment and employment, as well as other demographic and economic variables.
### Read in R packages
```{r eval=FALSE}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(data.table)
#library(ff)
#library(ffbase2)
library(rgdal)
options(scipen=999,stringsAsFactors = F)
sum2=function(x){sum(x,na.rm=TRUE)}
mean2=function(x){mean(x,na.rm=TRUE)}

#setwd("C:/Users/LocalAdmin/Desktop")
#data.dir <- "E:/My Documents/Important Files/Work/SESYNC/Data analysis/IPUMS/ipums_extract"
setwd("C:/Users/LocalAdmin/Documents/OneDrive - Conservation International 1/Data analysis/IPUMS")
setwd("E:/My Documents/Important Files/Work/SESYNC/Data analysis/IPUMS/ipums_extract")    # location of downloaded microdata
#dsn <- "E:/My Documents/Important Files/Work/SESYNC/GIS/IPUMS"# location of shapefiles
```

## Read in the data in ffdf format
Reading files as a ffdf allows users to work with large dataframes without storing them in memory. Although they take quite a while to read into R and to convert to dataframes, they can be queried (i.e. you can select portions of the data you need) using the *filter* function.
```{r eval=FALSE}
#system.time(asia<- read.csv.ffdf(file="ipumsi_asia.csv", header=TRUE, VERBOSE=TRUE, 
#                  first.rows=1000000, next.rows=1000000, colClasses=NA))
#system.time(x <- fread('ipumsi_00028.csv',nrows=10000000))
#headernames <- names(x)
#pryr::object_size(asia)
setwd("E:/My Documents/Important Files/Work/SESYNC/Data analysis/IPUMS/ipums_extract")    # location of downloaded microdata
# read in data
y <- "ipums_826.csv"
system.time(x <- fread(y))
```

Remove most variables (except the important ones!) to free up RAM and the variable enviornment
```{r eval=FALSE}
rm(list=setdiff(ls(), c("x","asia","europe","namerica","samerica","africa","clist","IPUMSagg","CSVextract")))

```

## Aggregation function
This function does the following:

* reads in data chunk from the csv
* aggregates the data for the select variables of interest at the geolevel2 scale. 
* writes the aggregated data to a new file called **out.table**

The variables of interest are:

* **Total population**: this gives us total population (based on person weights) within the geography of interest (*popXX*) 
* **Education**: the % of the population who are 25+ years old, for whom educ. attainment is determined, with secondary (*phsXX*) or university (*pcolXX*) level education
* **Unemployment**: the % of individuals within the total workforce (excluding inactive members), for whom employment status is determined, who are unemployed  (*punempXX*).
* **Professional**: the % of individuals within the total employed workforce, for whom employment status is determined, who are employed in a professional occupation  (*pprofXX*). 
* **Female labor force employment**: the % of individuals within the total employed workforce, for whom employment status is determined, who are employed in a professional occupation  (*pflabfXX*).  

### Code test
Use this subsection to test the code with 1 country
```{r eval=FALSE}
y <- "ipumsi_00037.csv"
system.time(x <- fread(y))

#clist <- unique(x$COUNTRY)       # get a list of all the countries in the dataset
#i <- 1
```

### IPUMSagg function 
```{r eval=FALSE}
IPUMSagg <- function (x) {
 # out.table <<- data.frame()        # create an empty dataframe
  join.names <- c("COUNTRY", "YEAR", "GEOLEV1", "GEOLEV2")
  x <- filter(x,!is.na(GEOLEV1))   # remove entries without Geolevel data (shouldn't happen!)

if (nrow(x)>0 & nrow(filter(x,is.na(AGE)))/nrow(x)<0.1) {  # run if countries are not missing most of the data

tot.popn <- x %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(popXX = sum(PERWT))

#--Education                                    
# number of persons with hs degree or less (Secondary education)
  if (class(x$EDATTAIND)!="NULL" | !is.na(sum(x$EDATTAIND))) {
educsec <- filter(x,EDATTAIND%in%(311:322) & AGE%in%c(25:100)) %>% # ages 25+ yrs
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(edusecondXX = sum(PERWT))
educD <- filter(x,EDATTAIND%in%(100:400) & AGE%in%c(25:100)) %>% # ages 25+ yrs
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(educDXX = sum(PERWT))

# number persons with at least a four year college degree
educter <- filter(x,EDATTAIND==400 & AGE%in%c(25:100)) %>% # ages 25+ yrs
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(educterXX = sum(PERWT))
   }
  else{
  educsec <- data.frame(tot.popn[,1:4],edusecondXX=NA);educD <- data.frame(tot.popn[,1:4],educDXX=NA);
  educter <- data.frame(tot.popn[,1:4],educterXX=NA);
    }

# Percent of persons age 10+ literate(numerator)"
  if (class(x$LIT)!="NULL" | !is.na(sum(x$LIT))) {
lit10N <- filter(x,LIT==2 & AGE%in%c(10:100)) %>% # ages 25+ yrs
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(lit10NXX = sum(PERWT))

# Percent of persons age 10+ literate (denominator)"
lit10D <- filter(x,LIT%in%c(1:2) & AGE%in%c(10:100)) %>% # ages 25+ yrs
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(lit10DXX = sum(PERWT))
   }
  else{
  lit10N <- data.frame(tot.popn[,1:4],lit10NXX=NA);lit10D <- data.frame(tot.popn[,1:4],lit10DXX=NA)
    }

educ <- tot.popn[join.names] %>% 
  left_join(educsec,by = join.names) %>% 
  left_join(educter,by = join.names) %>% 
  left_join(educD,by = join.names) %>% 
  left_join(lit10N,by = join.names) %>% 
  left_join(lit10D,by = join.names)

#--Employment
# Current labor force (employed and unemployed individuals between 16-65; excludes housework)
#empclf <- filter(x,EMPSTATD%in%c(100:240) & AGE%in%c(16:65)) %>%
#  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
#  summarize(empclfXX = sum(PERWT))

# Civilian labor force- persons 16 years and over (excluding armed forces where occupation is known)
  if ((class(x$EMPSTATD)!="NULL"| !is.na(sum(x$LIT))) & (class(x$OCCISCO)!="NULL" | !is.na(sum(x$LIT)))) {
clf <- filter(x,EMPSTATD%in%c(100:120,140:240) & AGE%in%c(16:65) & !OCCISCO%in%c(10,97:99)) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>% #eliminating other column headers
  summarize(clfXX = sum(PERWT)) #can add abbreviated function due to <%> piping
# Unemployment for individuals between 16-65 (of civilians)
unempl <- filter(x,EMPSTATD%in%c(200:240) & AGE%in%c(16:65) & !OCCISCO%in%c(10,97:99)) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(unempXX = sum(PERWT)) 

# Females 16 and over, not in armed forces (generally, employed or actively seeking employment)
lfpfemN <- filter(x,SEX==2 & EMPSTATD%in%c(100:120,140) & AGE%in%c(16:65) & !OCCISCO%in%c(10,97:99)) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(lfpfemNXX= sum(PERWT))
lfpfemD <- filter(x,SEX==2 & EMPSTATD%in%c(100:120,140:240) & AGE%in%c(16:65) & !OCCISCO%in%c(10,97:99)) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(lfpfemDXX= sum(PERWT))

# Percent of workers in professional or technical occupations (excluding clerks)
occprofN <- filter(x,AGE%in%c(16:65) & EMPSTATD%in%c(100:120,140) & OCCISCO%in%c(1:3)) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(occprofNXX = sum(PERWT)) 
occprofD <- filter(x,AGE%in%c(16:65) & EMPSTATD%in%c(100:120,140) & !OCCISCO%in%c(10,97:99)) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(occprofDXX = sum(PERWT)) 

# Percent of currently employed persons age 16 to 65 who are working in agriculture or fisheries
occagrN <- filter(x,AGE%in%c(16:65) & EMPSTATD%in%c(100:120,140) & OCCISCO==6) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(occagrNXX = sum(PERWT)) 
occagrD <- filter(x,AGE%in%c(16:65) & EMPSTATD%in%c(100:120,140) & !OCCISCO%in%c(10,97:99)) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(occagrDXX = sum(PERWT)) 

empl <- tot.popn[join.names] %>%
  left_join(clf,by=join.names) %>%
  left_join(unempl,by=join.names) %>%
  left_join(lfpfemN,by=join.names) %>%
  left_join(lfpfemD,by=join.names) %>%
  left_join(occprofN,by=join.names) %>%
  left_join(occprofD,by=join.names) %>%
  left_join(occagrN,by=join.names) %>%
  left_join(occagrD,by=join.names) 
   }
  else{
  empl <- data.frame(tot.popn[,1:4],clfXX=NA)
    }

#--Assets
# Refrigerator ownership
  if (class(x$REFRIG)!="NULL" ) {
refrigN <- filter(x,REFRIG==2 & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(refrigNXX = sum(HHWT))
refrigD <- filter(x,REFRIG%in%c(1:2) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(refrigDXX = sum(HHWT)) 
   }
  else{
  refrigN <- data.frame(tot.popn[,1:4],refrigNXX=NA);refrigD <- data.frame(tot.popn[,1:4],refrigDXX=NA)
    }

# hot water access (water heater in unit)
  if (class(x$HOTWATER)!="NULL") {
hotwaterN <- filter(x,HOTWATER==2 & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(hotwaterNXX = sum(HHWT))
hotwaterD <- filter(x,HOTWATER%in%c(1:2) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(hotwaterDXX = sum(HHWT)) 
   }
  else{
  hotwaterN <- data.frame(tot.popn[,1:4],hotwaterNXX=NA);hotwaterD <- data.frame(tot.popn[,1:4],hotwaterDXX=NA)
    }

# cellphone access
  if (class(x$CELL)!="NULL") {
  cellN <- filter(x,CELL==1 & GQ==10 & PERNUM==1) %>%
        group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
        summarize(cellNXX = sum(HHWT))
  cellD <- filter(x,CELL%in%c(1:2) & GQ==10 & PERNUM==1) %>%
        group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
        summarize(cellDXX = sum(HHWT))
   }
  else{
  cellN <- data.frame(tot.popn[,1:4],cellNXX=NA);cellD <- data.frame(tot.popn[,1:4],cellDXX=NA)
    }


# TV ownership
  if (class(x$TV)!="NULL") {
tvN <- filter(x,TV%in%c(20:43) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(tvNXX = sum(HHWT))
tvD <- filter(x,TV%in%c(10:43) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(tvDXX = sum(HHWT)) 
   }
  else{
  tvN <- data.frame(tot.popn[,1:4],tvNXX=NA);tvD <- data.frame(tot.popn[,1:4],tvDXX=NA)
    }

# Radio ownership
  if (class(x$RADIO)!="NULL") {
radioN <- filter(x,RADIO==2 & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(radioNXX = sum(HHWT))
radioD <- filter(x,RADIO%in%c(1:2) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(radioDXX = sum(HHWT)) 
   }
  else{
  radioN <- data.frame(tot.popn[,1:4],radioNXX=NA);radioD <- data.frame(tot.popn[,1:4],radioDXX=NA)
    }

# phone ownership
  if (class(x$PHONE)!="NULL") {
phoneN <- filter(x,PHONE==2 & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(phoneNXX = sum(HHWT))
phoneD <- filter(x,PHONE%in%c(1:2) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(phoneDXX = sum(HHWT)) 
   }
  else{
  phoneN <- data.frame(tot.popn[,1:4],phoneNXX=NA);phoneD <- data.frame(tot.popn[,1:4],phoneDXX=NA)
    }

# computer ownership
  if (class(x$COMPUTER)!="NULL") {
computerN <- filter(x,COMPUTER==2 & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(computerNXX = sum(HHWT))
computerD <- filter(x,COMPUTER%in%c(1:2) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(computerDXX = sum(HHWT)) 
   }
  else{
  computerN <- data.frame(tot.popn[,1:4],computerNXX=NA);computerD <- data.frame(tot.popn[,1:4],computerDXX=NA)
    }

# internet access
  if (class(x$INTERNET)!="NULL") {
internetN <- filter(x,INTERNET==2 & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(internetNXX = sum(HHWT))
internetD <- filter(x,INTERNET%in%c(1:2) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(internetDXX = sum(HHWT)) 
   }
  else{
  internetN <- data.frame(tot.popn[,1:4],internetNXX=NA);internetD <- data.frame(tot.popn[,1:4],internetDXX=NA)
    }

# Washer ownership
  if (class(x$WASHER)!="NULL") {
washerN <- filter(x,WASHER%in%c(2:4) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(washerNXX = sum(HHWT))
washerD <- filter(x,WASHER%in%c(1:4) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(washerDXX = sum(HHWT)) 
   }
  else{
  washerN <- data.frame(tot.popn[,1:4],washerNXX=NA);washerD <- data.frame(tot.popn[,1:4],washerDXX=NA)
    }

# Air-conditioner ownership
  if (class(x$AIRCON)!="NULL") {
airconN <- filter(x,AIRCON%in%c(20:29) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(airconNXX = sum(HHWT))
airconD <- filter(x,AIRCON%in%c(10:29) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(airconDXX = sum(HHWT)) 
   }
  else{
  airconN <- data.frame(tot.popn[,1:4],airconNXX=NA);airconD <- data.frame(tot.popn[,1:4],airconDXX=NA)
    }

# Auto ownership
  if (class(x$AUTOS)!="NULL") {
autoN <- filter(x,AUTOS%in%c(1:7) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(autoNXX = sum(HHWT))
autoD <- filter(x,AUTOS%in%c(0:7) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(autoDXX = sum(HHWT)) 
   }
  else{
  autoN <- data.frame(tot.popn[,1:4],autoNXX=NA);autoD <- data.frame(tot.popn[,1:4],autoDXX=NA)
    }


assets <- tot.popn[join.names]   %>%
  left_join(hotwaterN,by=join.names) %>%
  left_join(hotwaterD,by=join.names) %>%
  left_join(cellN,by=join.names) %>%
  left_join(cellD,by=join.names) %>%
  left_join(refrigN,by=join.names) %>%
  left_join(refrigD,by=join.names) %>%
  left_join(tvN,by=join.names) %>%
  left_join(tvD,by=join.names) %>% 
  left_join(radioN,by=join.names) %>%
  left_join(radioD,by=join.names) %>%
  left_join(phoneN,by=join.names) %>%
  left_join(phoneD,by=join.names) %>%
  left_join(computerN,by=join.names) %>%
  left_join(computerD,by=join.names) %>%
  left_join(internetN,by=join.names) %>%
  left_join(internetD,by=join.names) %>%
  left_join(washerN,by=join.names) %>%
  left_join(washerD,by=join.names) %>%
  left_join(airconN,by=join.names) %>%
  left_join(airconD,by=join.names) %>%
  left_join(autoN,by=join.names) %>%
  left_join(autoD,by=join.names)


#-- Household attributes
#Percent of households with electricity
  if (class(x$ELECTRIC)!="NULL") {
electricN <- filter(x,ELECTRIC==1 & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(electricNXX = sum(HHWT))
electricD <- filter(x,ELECTRIC%in%c(1:2) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(electricDXX = sum(HHWT)) 
   }
  else{
  electricN <- data.frame(tot.popn[,1:4],electricNXX=NA);electricD <- data.frame(tot.popn[,1:4],electricDXX=NA)
    }

#Percent of households with a flush toilet
  if (class(x$TOILET)!="NULL") {
flushtoiletN <- filter(x,TOILET==21 & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize( flushtoiletNXX = sum(HHWT))
flushtoiletD <- filter(x,TOILET%in%c(10:23) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(flushtoiletDXX = sum(HHWT))
   }
  else{
  flushtoiletN <- data.frame(tot.popn[,1:4],flushtoiletNXX=NA);flushtoiletD <- data.frame(tot.popn[,1:4],flushtoiletDXX=NA)
    }

# Cooking fuel
#Electricity
  if (class(x$FUELCOOK)!="NULL") {
cookelectN <- filter(x,FUELCOOK==20 & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(cookelectNXX = sum(HHWT))
cookD <- filter(x,FUELCOOK%in%c(10:77) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(cookDXX = sum(HHWT))
#Gas
cookgasN <- filter(x,FUELCOOK%in%c(30:47) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(cookgasNXX = sum(HHWT))
#Wood and solid fuels
cookwoodN <- filter(x,FUELCOOK%in%c(50:56) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(cookwoodNXX = sum(HHWT))
   }
  else{
  cookelectN <- data.frame(tot.popn[,1:4],cookelectNXX=NA); cookD <- data.frame(tot.popn[,1:4],cookDXX=NA);
  cookgasN <- data.frame(tot.popn[,1:4],cookgasNXX=NA); cookwoodN <- data.frame(tot.popn[,1:4],cookwoodNXX=NA)
    }

#Percentage of households with access to piped water
  if (class(x$WATSUP)!="NULL") {
pipedN <- filter(x,WATSUP%in%c(10:18) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(pipedNXX = sum(HHWT))
pipedD <- filter(x,WATSUP%in%c(10:20) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(pipedDXX = sum(HHWT))
   }
  else{
  pipedN <- data.frame(tot.popn[,1:4],pipedNXX=NA);pipedD <- data.frame(tot.popn[,1:4],pipedDXX=NA)
    }

#Percentage of households with access to sewage facilities
  if (class(x$SEWAGE)!="NULL") {
sewageN <- filter(x,SEWAGE%in%c(10:12) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(sewageNXX = sum(HHWT))
sewageD <- filter(x,SEWAGE%in%c(10:20) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(sewageDXX = sum(HHWT))
   }
  else{
  sewageN <- data.frame(tot.popn[,1:4],sewageNXX=NA);sewageD <- data.frame(tot.popn[,1:4],sewageDXX=NA)
    }

#Percentage household ownership
  if (class(x$OWNERSHIP)!="NULL") {
homeownN <- filter(x,OWNERSHIP==1 & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(homeownNXX = sum(HHWT))
homeownD <- filter(x,OWNERSHIP%in%c(1:2) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(homeownDXX = sum(HHWT))
   }
  else{
  homeownN <- data.frame(tot.popn[,1:4],homeownNXX=NA);homeownD <- data.frame(tot.popn[,1:4],homeownDXX=NA)
    }

#Percentage land ownership
  if (class(x$LANDOWN)!="NULL") {
landownN <- filter(x,LANDOWN%in%c(10:14) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(landownNXX = sum(HHWT))
landownD <- filter(x,LANDOWN%in%c(10:30) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(landownDXX = sum(HHWT))
   }
  else{
  landownN <- data.frame(tot.popn[,1:4],landownNXX=NA);landownD <- data.frame(tot.popn[,1:4],landownDXX=NA)
    }

#Roof types
# Masonary, concrete, tiles
  if (class(x$ROOF)!="NULL") {
roofmasonN <- filter(x,ROOF%in%c(10:29) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(roofmasonNXX = sum(HHWT))
roofD <- filter(x,ROOF%in%c(10:90) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(roofDXX = sum(HHWT))
# Metal
roofmetalN <- filter(x,ROOF%in%c(30:35) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(roofmetalNXX = sum(HHWT))
# Wood and/or clay
roofwoodN <- filter(x,ROOF%in%c(40:61) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(roofwoodNXX = sum(HHWT))
   }
  else{
  roofmasonN <- data.frame(tot.popn[,1:4],roofmasonNXX=NA);roofD <- data.frame(tot.popn[,1:4],roofDXX=NA);
  roofmetalN <- data.frame(tot.popn[,1:4],roofmetalNXX=NA);roofwoodN <- data.frame(tot.popn[,1:4],roofwoodNXX=NA)
    }

#trash
# Collected or not collected
  if (class(x$TRASH)!="NULL") {
trashcollectN <- filter(x,TRASH%in%c(10:14) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(trashcollectNXX = sum(HHWT))
trashcollectD <- filter(x,TRASH%in%c(10:39) & GQ==10 & PERNUM==1) %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(trashcollectDXX = sum(HHWT))
   }
  else{
  trashcollectN <- data.frame(tot.popn[,1:4],trashcollectNXX=NA);trashcollectD <- data.frame(tot.popn[,1:4],trashcollectDXX=NA)
    }

#Person per household                                      
hhsize <- filter(x, GQ==10 & PERNUM==1) %>% 
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarize(hhsizeXX = sum2(PERSONS*HHWT)/sum2(HHWT))


houseatt <- tot.popn[join.names]   %>%
  left_join(electricN,by=join.names) %>%
  left_join(electricD,by=join.names) %>%
  left_join(flushtoiletN,by=join.names) %>%
  left_join(flushtoiletD,by=join.names) %>%
  left_join(cookelectN,by=join.names) %>%
  left_join(cookgasN,by=join.names) %>%
  left_join(cookwoodN,by=join.names) %>%
  left_join(cookD,by=join.names) %>% 
  left_join(pipedN,by=join.names) %>%
  left_join(pipedD,by=join.names) %>%
  left_join(sewageN,by=join.names) %>%
  left_join(sewageD,by=join.names) %>%
  left_join(homeownN,by=join.names) %>%
  left_join(homeownD,by=join.names) %>%
  left_join(landownN,by=join.names) %>%
  left_join(landownD,by=join.names) %>%
  left_join(roofmasonN,by=join.names) %>%
  left_join(roofmetalN,by=join.names) %>%  
  left_join(roofwoodN,by=join.names) %>%
  left_join(roofD,by=join.names) %>%
  left_join(trashcollectN,by=join.names) %>%
  left_join(trashcollectD,by=join.names) %>%
  left_join(hhsize,by=join.names)
  

c2 <- tot.popn %>%
  left_join(educ,by=join.names) %>%
  left_join(empl,by=join.names) %>%
  left_join(assets, by=join.names) %>%
  left_join(houseatt,by=join.names) 

#write.csv(c2, 'IPUMS_test_final_output.csv', row.names=FALSE)
   
  out.table <<- rbind(out.table,as.data.frame(c2))
# rm(list=setdiff(ls(), c("x","IPUMSagg","CSVextract","sum2","out.table")))
 rm (x)
  print(paste0("Country ",i, " completed"))
  }
  else {
  rm(x)
  print(paste0("Country ",i, " missing Geolevel data or numerous age records"))
  } # end if else
}   # end function
```


### Test run
```{r eval=FALSE}
setwd("E:/My Documents/Important Files/Work/SESYNC/Data analysis/IPUMS/data/ipumsi_countries")    # location of downloaded microdata
file.list<- list.files('.',recursive = T, full.names = T)
  out.table <<- data.frame()        # create an empty dataframe

for (i in 1:length(file.list)){
  print(file.list[i])
  x <- fread(file.list[i], showProgress = T)
  IPUMSagg(x)
}

```



### CSVextract function 
This function:

1. uses **fread** from the data.table package to quickly read in the csv (1 )
```{r eval=FALSE}
# get number of rows in the entire file (1-2 min)
CSVextract <- function(y) {
ptm <- proc.time()               # to figure out how long it takes to run the function
system.time(x <- fread(y,select="COUNTRY"))
num.rows <- nrow(x)
read.rows <- 10000000
num.reps <- round(num.rows/read.rows,digits=0)
num.reps <- ifelse(num.rows<read.rows*num.reps,num.reps-1,num.reps)
all.data <<- data.frame()        # create an empty dataframe

# start with first 10 million rows
system.time(x <- fread(y,nrows=read.rows))
headernames <- names(x)
IPUMSagg(x)
all.data <-rbind(out.table,all.data)
rm(x)

for (j in 1:num.reps){
system.time(x <- fread(y,nrows=read.rows, skip=(j*read.rows+1),
                       col.names = headernames))
IPUMSagg(x)
all.data <-rbind(out.table,all.data)
rm(x)
}
all.data <<-all.data %>%
  group_by(COUNTRY,YEAR,GEOLEV1,GEOLEV2) %>%
  summarise_all(funs(sum2), popXX:hhsizeXX)

proc.time() - ptm
}
```

Extract data from a csv
```{r eval=FALSE}
list <- list.files()
CSVextract('ipumsi_00037.csv')
c4 <- all.data %>%
  mutate(peducsecXX=edusecondXX/educDXX;
         peducterXX=educterXX/educDXX;
         pLIT10XX=LIT10NXX/LIT10DXX;
         punempXX=unempXX/clfXX;
         plfpfemXX=lfpfemNXX/lfpfemDXX;
         poccprofXX=occprofNXX/occprofDXX;
         poccagrXX=occagrNXX/occagrDXX;
         photwaterXX=hotwaterNXX/hotwaterDXX;
         pcellXX=cellNXX/cellDXX;
         punempXX=unempXX/clfXX;
         punempXX=unempXX/clfXX;
         punempXX=unempXX/clfXX;
         punempXX=unempXX/clfXX;
         punempXX=unempXX/clfXX;
         punempXX=unempXX/clfXX;
         punempXX=unempXX/clfXX;
         punempXX=unempXX/clfXX;
         punempXX=unempXX/clfXX;
         punempXX=unempXX/clfXX;)


write.csv(all.data,"test.csv")
unique(all.data$COUNTRY)
```

## Compile all regions
**After all the code is fixed and variables chosen**, run this section to organize the data so that there is only 1 row per geolevel unit. Finally, separate the geolevel 1 and 2 data and join to the geolevel shapefiles.
```{r eval=FALSE}
IPUMSagg(x)
#summarise data
c3 <- 

head(glvl1.data)
glvl1.data <- all.data %>%
  filter(is.na(GEOLEV2)) %>%
  gather(var,value, popXX:pprofXX) %>%
  mutate(var1=paste0(gsub("X","",var),substr(YEAR,3,4)))%>%
  select(-YEAR,-var,-GEOLEV2) %>%
  spread(var1, value)

glvl2.data <- all.data %>%
  filter(!is.na(GEOLEV2)) %>%
  gather(var,value, popXX:pprofXX) %>%
  mutate(var1=paste0(gsub("X","",var),substr(YEAR,3,4)))%>%
  select(-YEAR,-var) %>%
  spread(var1, value)

# Read in aMerge with the shapefiles

Glvl1.shp <- readOGR(dsn,'world_geolev1')
Glvl2.shp <- readOGR(dsn,'world_geolev2')

Glvl1.shp2<- merge(Glvl1.shp,glvl1.data,by.x="GEOLEVEL1",by.y='GEOLEV1') # merge data
writeOGR(Glvl1.shp2,dsn,'IPUMS_geo1',driver = "ESRI Shapefile")

Glvl2.shp2<- merge(Glvl2.shp,glvl2.data,by.x="GEOLEVEL2",by.y='GEOLEV2') # merge data
writeOGR(Glvl2.shp2,dsn,'IPUMS_geo2',driver = "ESRI Shapefile")

```
